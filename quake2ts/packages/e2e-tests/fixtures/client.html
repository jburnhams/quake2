<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E2E Connection Test Client</title>
</head>
<body>
    <h1>Connection Test Client</h1>
    <div id="status">Disconnected</div>
    <div id="logs"></div>
    <button id="disconnectBtn" onclick="doDisconnect()">Disconnect</button>

    <script>
        let ws;

        function log(msg) {
            console.log(msg);
            const logs = document.getElementById('logs');
            const div = document.createElement('div');
            div.textContent = msg;
            logs.appendChild(div);
        }

        function doDisconnect() {
            if (ws) {
                ws.close();
                ws = null;
            }
        }

        // Parse query params
        const params = new URLSearchParams(window.location.search);
        const serverUrl = params.get('connect');

        if (serverUrl) {
            log('Connecting to ' + serverUrl);

            ws = new WebSocket(serverUrl, 'quake2');
            ws.binaryType = 'arraybuffer';

            ws.onopen = () => {
                log('ConnectionState.Connected');
                document.getElementById('status').textContent = 'Connected';
            };

            ws.onmessage = (event) => {
                log('Received data: ' + event.data.byteLength + ' bytes');

                // Minimal heuristic: If we receive a packet > 100 bytes, it's likely containing configstrings/serverdata
                // A keepalive or empty packet is small (header only ~10 bytes).
                if (event.data.byteLength > 100) {
                     log('Handshake Data Received');
                     document.getElementById('status').textContent = 'Active';
                }
            };

            ws.onclose = () => {
                log('Disconnected');
                document.getElementById('status').textContent = 'Disconnected';
            };

            ws.onerror = (e) => {
                log('Error: ' + e);
            };
        }
    </script>
</body>
</html>
