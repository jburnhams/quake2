<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Quake 2 TS - E2E Test Harness</title>
    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: #000; }
        canvas { display: block; width: 100%; height: 100%; }
        #debug {
            position: absolute;
            top: 10px;
            left: 10px;
            color: white;
            font-family: monospace;
            z-index: 100;
            white-space: pre;
            background: rgba(0,0,0,0.5);
            padding: 5px;
        }
        #status {
            position: absolute;
            top: 50px;
            left: 10px;
            color: lime;
            font-family: monospace;
            z-index: 100;
        }
    </style>
</head>
<body>
    <div id="debug">Initializing...</div>
    <div id="status">Disconnected</div>
    <div id="logs" style="display:none;"></div>
    <canvas id="game-canvas"></canvas>

    <script src="/packages/client/dist/browser/index.global.js"></script>

    <script>
        async function start() {
            console.log('Harness script loaded.');

            const debug = document.getElementById('debug');
            const statusDiv = document.getElementById('status');
            debug.innerText = 'Loading client...';
            console.log('Starting harness...');

            try {
                // Parse query params for connection info
                const params = new URLSearchParams(window.location.search);
                const serverUrl = params.get('connect');

                if (!serverUrl) {
                    debug.innerText = 'No server URL provided in ?connect=';
                    console.error('No server URL provided. Search params:', window.location.search);
                    return;
                }

                debug.innerText = `Connecting to ${serverUrl}...`;
                console.log(`Connecting to ${serverUrl}...`);

                if (typeof Quake2Client === 'undefined') {
                    throw new Error('Quake2Client global not found. Bundle might be missing or invalid.');
                }

                // MOCK ENGINE
                const mockRenderer = {
                    width: 1280,
                    height: 720,
                    stats: {},
                    collisionVis: { render: () => {}, clear: () => {} },
                    renderFrame: () => {},
                    begin2D: () => {},
                    end2D: () => {},
                    registerPic: async (name) => ({ width: 16, height: 16, bind: () => {} }),
                    registerTexture: (name) => ({ width: 16, height: 16, bind: () => {} }),
                    drawPic: () => {},
                    drawString: () => {},
                    drawCenterString: () => {},
                    drawfillRect: () => {},
                    setGamma: () => {},
                    setBrightness: () => {},
                    setBloom: () => {},
                    setBloomIntensity: () => {},
                    setUnderwaterWarp: () => {},
                    getPerformanceReport: () => ({ textureBinds: 0, triangles: 0, drawCalls: 0, vertices: 0 }),
                    setDebugMode: () => {},
                    setEntityHighlight: () => {},
                    clearEntityHighlight: () => {}
                };

                const mockAssets = {
                    getMap: () => null,
                    listFiles: () => [],
                    loadTexture: async () => ({ width: 16, height: 16, rgba: new Uint8Array(16*16*4) }),
                    loadSprite: async () => ({ frames: [] }),
                    loadSound: async () => ({ duration: 0, buffer: null })
                };

                const mockEngine = {
                    renderer: mockRenderer,
                    assets: mockAssets,
                    trace: (start, end, mins, maxs) => {
                        // Return a clear trace
                        return {
                            fraction: 1.0,
                            contents: 0,
                            allSolid: false,
                            startSolid: false,
                            endpos: { x: end.x, y: end.y, z: end.z },
                            plane: { normal: { x: 0, y: 0, z: 1 }, dist: 0, type: 0 }
                        };
                    },
                    audio: {
                        play_track: () => {},
                        play_music: () => {},
                        stop_music: () => {},
                        set_music_volume: () => {}
                    }
                };

                const mockHost = {
                    commands: {
                        register: () => {},
                        execute: () => {}
                    },
                    cvars: {
                        get: (name) => {
                            if (name === 'net_qport') {
                                const qport = params.get('qport');
                                if (qport) return { string: qport, number: parseInt(qport, 10), flags: 0 };
                            }
                            if (name === 'name') return { string: 'TestPlayer', number: 0, flags: 0 };
                            return { string: '', number: 0, flags: 0 };
                        },
                        register: () => {},
                        list: () => [],
                        setValue: () => {}
                    }
                };

                // Mock InputController to allow test injection
                const mockInputController = {
                    buildCommand: (dt, now) => {
                        // Ensure window.testInput is used if present
                        if (window.testInput) {
                            const cmd = window.testInput;
                            cmd.time = now;
                            return cmd;
                        }
                        return {
                            angles: {x:0, y:0, z:0},
                            forwardmove: 0,
                            sidemove: 0,
                            upmove: 0,
                            buttons: 0,
                            impulse: 0,
                            msec: 16, // Default msec
                            time: now
                        };
                    },
                    bindInputSource: () => {},
                    setKeyBinding: () => {},
                    getDefaultBindings: () => ({}),
                    set onInputCommand(cb) { this._cb = cb; },
                    get onInputCommand() { return this._cb; }
                };

                // Initialize Client
                console.log('Creating client instance...');
                const client = Quake2Client.createClient({
                    engine: mockEngine,
                    host: mockHost,
                    inputController: mockInputController
                });

                window.clientInstance = client;

                // Monitor connection state
                client.multiplayer.onConnectionStateChange = (state) => {
                    const states = ['Disconnected', 'Connecting', 'Challenge', 'Connected', 'Loading', 'Active'];
                    const stateName = states[state] || 'Unknown';
                    console.log(`Connection State: ${stateName}`);
                    statusDiv.textContent = stateName;
                };

                // Create dummy state to prevent render crash
                const dummyState = {
                    origin: { x: 0, y: 0, z: 0 },
                    velocity: { x: 0, y: 0, z: 0 },
                    viewAngles: { x: 0, y: 0, z: 0 },
                    timeMs: 0,
                    pmFlags: 0,
                    waterLevel: 0,
                    health: 100,
                    armor: 0,
                    ammo: 0,
                    stats: new Array(32).fill(0),
                    damageAlpha: 0,
                    damageIndicators: [],
                    blend: [0, 0, 0, 0],
                    pickupIcon: 0,
                    packetEntities: []
                };

                // Initialize
                console.log('Initializing client...');
                client.init({ state: dummyState, timeMs: 0 });

                debug.innerText = `Client initialized. Connecting to ${serverUrl}...`;
                console.log('Client initialized.');

                // Force menu closed just in case
                if (client.hidePauseMenu) client.hidePauseMenu();

                // Connect
                try {
                    console.log('Initiating connection...');
                    await client.multiplayer.connect(serverUrl);
                    debug.innerText = 'Connected!';
                    console.log('Connected!');
                    statusDiv.textContent = 'Connected';
                } catch (err) {
                     debug.innerText = `Connection failed: ${err.message}`;
                     console.error(`Connection failed: ${err.message}`);
                     // Don't throw, let loop start (but connection state will be disconnected)
                }

                // Start Render Loop to drive processing
                function loop() {
                    try {
                        const now = performance.now();

                        // Render (drives frame logic and input generation)
                        client.render({
                            nowMs: now,
                            alpha: 1.0,
                            latest: null, // We rely on multiplayer connection to update state internally if needed
                            previous: null
                        });

                        requestAnimationFrame(loop);
                    } catch (loopErr) {
                         console.error('Render loop crashed:', loopErr);
                         debug.innerText = `Crash: ${loopErr.message}`;
                    }
                }
                requestAnimationFrame(loop);

            } catch (e) {
                debug.innerText = `Error: ${e.message}\n${e.stack}`;
                console.error(`Harness error: ${e.message}`);
                console.error(e.stack);
            }
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', start);
        } else {
            start();
        }
    </script>
</body>
</html>
