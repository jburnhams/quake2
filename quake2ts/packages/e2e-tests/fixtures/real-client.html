<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Quake 2 TS - E2E Test Harness</title>
    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: #000; }
        canvas { display: block; width: 100%; height: 100%; }
        #debug {
            position: absolute;
            top: 10px;
            left: 10px;
            color: white;
            font-family: monospace;
            z-index: 100;
            white-space: pre;
            background: rgba(0,0,0,0.5);
            padding: 5px;
        }
    </style>
</head>
<body>
    <div id="debug">Initializing...</div>
    <canvas id="game-canvas"></canvas>

    <script src="/packages/client/dist/browser/index.global.js"></script>

    <script>
        async function start() {
            const debug = document.getElementById('debug');
            debug.innerText = 'Loading client...';

            try {
                // Parse query params for connection info
                const params = new URLSearchParams(window.location.search);
                const serverUrl = params.get('connect');

                if (!serverUrl) {
                    debug.innerText = 'No server URL provided in ?connect=';
                    return;
                }

                debug.innerText = `Connecting to ${serverUrl}...`;

                if (typeof Quake2Client === 'undefined') {
                    throw new Error('Quake2Client global not found. Bundle might be missing or invalid.');
                }

                console.log('Quake2Client exports:', Object.keys(Quake2Client));

                // MOCK ENGINE
                // We need to provide ClientImports to createClient
                const mockRenderer = {
                    width: 1280,
                    height: 720,
                    renderFrame: () => {},
                    begin2D: () => {},
                    end2D: () => {},
                    stats: {}
                };

                const mockAssets = {
                    getMap: () => null,
                    listFiles: () => []
                };

                const mockEngine = {
                    renderer: mockRenderer,
                    assets: mockAssets,
                    trace: () => ({ fraction: 1.0, contents: 0 })
                };

                const mockHost = {
                    commands: {
                        register: () => {},
                        execute: () => {}
                    },
                    cvars: {
                        get: () => ({ string: 'Player' }),
                        register: () => {},
                        list: () => []
                    }
                };

                // Initialize Client
                const client = Quake2Client.createClient({
                    engine: mockEngine,
                    host: mockHost
                });

                window.clientInstance = client;

                // Initialize
                client.init();

                debug.innerText = `Client initialized. Connecting to ${serverUrl}...`;

                // Connect
                // The multiplayer connection is exposed on client.multiplayer
                try {
                    await client.multiplayer.connect(serverUrl);
                    debug.innerText = 'Connected!';
                } catch (err) {
                     debug.innerText = `Connection failed: ${err.message}`;
                     throw err;
                }

                // Start Render Loop to drive processing
                function loop() {
                    const now = performance.now();
                    const cmd = {
                        angles: {x:0, y:0, z:0},
                        forwardmove: 0,
                        sidemove: 0,
                        upmove: 0,
                        buttons: 0,
                        impulse: 0,
                        msec: 16, // approx 60fps
                        time: now
                    };

                    // Predict/Update state
                    client.predict(cmd);

                    // Render (drives frame logic)
                    client.render({
                        nowMs: now,
                        alpha: 1.0,
                        latest: { timeMs: now, state: client.lastRendered },
                        previous: { timeMs: now - 16, state: client.lastRendered }
                    });

                    requestAnimationFrame(loop);
                }
                requestAnimationFrame(loop);

            } catch (e) {
                debug.innerText = `Error: ${e.message}\n${e.stack}`;
                console.error(e);
            }
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', start);
        } else {
            start();
        }
    </script>
</body>
</html>
