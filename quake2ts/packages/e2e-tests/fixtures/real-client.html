<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Quake 2 TS - E2E Test Harness</title>
    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: #000; }
        canvas { display: block; width: 100%; height: 100%; }
        #debug {
            position: absolute;
            top: 10px;
            left: 10px;
            color: white;
            font-family: monospace;
            z-index: 100;
            white-space: pre;
            background: rgba(0,0,0,0.5);
            padding: 5px;
        }
    </style>
</head>
<body>
    <div id="debug">Initializing...</div>
    <canvas id="game-canvas"></canvas>

    <script src="/packages/client/dist/browser/index.global.js"></script>

    <script>
        async function start() {
            console.log('Harness script loaded.');

            const debug = document.getElementById('debug');
            debug.innerText = 'Loading client...';
            console.log('Starting harness...');

            try {
                // Parse query params for connection info
                const params = new URLSearchParams(window.location.search);
                const serverUrl = params.get('connect');

                if (!serverUrl) {
                    debug.innerText = 'No server URL provided in ?connect=';
                    console.error('No server URL provided. Search params:', window.location.search);
                    return;
                }

                debug.innerText = `Connecting to ${serverUrl}...`;
                console.log(`Connecting to ${serverUrl}...`);

                if (typeof Quake2Client === 'undefined') {
                    throw new Error('Quake2Client global not found. Bundle might be missing or invalid.');
                }

                // MOCK ENGINE
                // We need to provide ClientImports to createClient
                const mockRenderer = {
                    width: 1280,
                    height: 720,
                    stats: {},
                    collisionVis: { render: () => {}, clear: () => {} },
                    renderFrame: () => {},
                    begin2D: () => {},
                    end2D: () => {},
                    registerPic: async (name) => ({ width: 16, height: 16, bind: () => {} }),
                    registerTexture: (name) => ({ width: 16, height: 16, bind: () => {} }),
                    drawPic: () => {},
                    drawString: () => {},
                    drawCenterString: () => {},
                    drawfillRect: () => {}
                };

                const mockAssets = {
                    getMap: () => null,
                    listFiles: () => [],
                    loadTexture: async () => ({ width: 16, height: 16, rgba: new Uint8Array(16*16*4) }),
                    loadSprite: async () => ({ frames: [] }),
                    loadSound: async () => ({ duration: 0, buffer: null })
                };

                const mockEngine = {
                    renderer: mockRenderer,
                    assets: mockAssets,
                    trace: (start, end) => ({
                        fraction: 1.0,
                        contents: 0,
                        allSolid: false,
                        startSolid: false,
                        endpos: { x: end.x, y: end.y, z: end.z },
                        plane: { normal: { x: 0, y: 0, z: 1 }, dist: 0, type: 0 }
                    })
                };

                const mockHost = {
                    commands: {
                        register: () => {},
                        execute: () => {}
                    },
                    cvars: {
                        get: () => ({ string: 'Player', number: 90, flags: 0 }),
                        register: () => {},
                        list: () => [],
                        setValue: () => {}
                    }
                };

                // Initialize Client
                console.log('Creating client instance...');
                const client = Quake2Client.createClient({
                    engine: mockEngine,
                    host: mockHost
                });

                window.clientInstance = client;

                // Create dummy state to prevent render crash
                const dummyState = {
                    origin: { x: 0, y: 0, z: 0 },
                    velocity: { x: 0, y: 0, z: 0 },
                    viewAngles: { x: 0, y: 0, z: 0 },
                    timeMs: 0,
                    pmFlags: 0,
                    waterLevel: 0,
                    health: 100,
                    armor: 0,
                    ammo: 0,
                    stats: new Array(32).fill(0),
                    damageAlpha: 0,
                    damageIndicators: [],
                    blend: [0, 0, 0, 0],
                    pickupIcon: 0,
                    packetEntities: []
                };

                // Initialize
                console.log('Initializing client...');
                client.init({ state: dummyState, timeMs: 0 });

                debug.innerText = `Client initialized. Connecting to ${serverUrl}...`;
                console.log('Client initialized.');

                // Connect
                // The multiplayer connection is exposed on client.multiplayer
                try {
                    console.log('Initiating connection...');
                    await client.multiplayer.connect(serverUrl);
                    debug.innerText = 'Connected!';
                    console.log('Connected!');
                } catch (err) {
                     debug.innerText = `Connection failed: ${err.message}`;
                     console.error(`Connection failed: ${err.message}`);
                     throw err;
                }

                // Start Render Loop to drive processing
                function loop() {
                    try {
                        const now = performance.now();
                        const cmd = window.testInput || {
                            angles: {x:0, y:0, z:0},
                            forwardmove: 0,
                            sidemove: 0,
                            upmove: 0,
                            buttons: 0,
                            impulse: 0,
                            msec: 16, // approx 60fps
                            time: now
                        };
                        // Ensure time is updated if using override
                        if (window.testInput) {
                            cmd.time = now;
                        }

                        // Predict/Update state
                        client.predict(cmd);

                        // Render (drives frame logic)
                        client.render({
                            nowMs: now,
                            alpha: 1.0,
                            latest: { timeMs: now, state: client.lastRendered || dummyState },
                            previous: { timeMs: now - 16, state: client.lastRendered || dummyState }
                        });

                        requestAnimationFrame(loop);
                    } catch (loopErr) {
                         console.error('Render loop crashed:', loopErr);
                         debug.innerText = `Crash: ${loopErr.message}`;
                    }
                }
                requestAnimationFrame(loop);

            } catch (e) {
                debug.innerText = `Error: ${e.message}\n${e.stack}`;
                console.error(`Harness error: ${e.message}`);
                console.error(e.stack);
            }
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', start);
        } else {
            start();
        }
    </script>
</body>
</html>
