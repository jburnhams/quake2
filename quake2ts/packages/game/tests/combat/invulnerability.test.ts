
import { describe, it, expect, vi, beforeEach } from 'vitest';
import { Entity, DeadFlag } from '../../src/entities/entity.js';
import { EntitySystem } from '../../src/entities/system.js';
import { EntityDamageFlags } from '../../src/combat/damageFlags.js';
import { player_think } from '../../src/entities/player.js';
import { PowerupId } from '../../src/inventory/playerInventory.js';
import { AmmoType } from '../../src/inventory/ammo.js';

describe('Invulnerability Powerup', () => {
    let player: Entity;
    let sys: EntitySystem;

    beforeEach(() => {
        player = new Entity(1);
        player.takedamage = true;
        player.health = 100;
        player.deadflag = DeadFlag.Alive;
        player.flags = 0;
        player.client = {
            inventory: {
                powerups: new Map(),
                ammo: { counts: [] },
                ownedWeapons: new Set(),
                keys: new Set(),
                items: new Set(),
            },
            weaponStates: {},
            invincible_time: 0,
            buttons: 0,
            pm_flags: 0,
            pm_type: 0,
            pm_time: 0,
            gun_frame: 0,
            rdflags: 0,
            fov: 90,
        } as any;

        sys = {
            timeSeconds: 10,
            scheduleThink: vi.fn(),
            sound: vi.fn(),
        } as unknown as EntitySystem;
    });

    it('should set GODMODE flag when invincible_time is active', () => {
        // Set invulnerability for 5 seconds
        player.client!.invincible_time = sys.timeSeconds + 5;

        player_think(player, sys);

        expect((player.flags! & EntityDamageFlags.GODMODE)).not.toBe(0);
    });

    it('should clear GODMODE flag when invincible_time expires', () => {
        // Set invulnerability expired
        player.client!.invincible_time = sys.timeSeconds - 1;
        player.flags = EntityDamageFlags.GODMODE; // Assume it was set

        player_think(player, sys);

        expect((player.flags! & EntityDamageFlags.GODMODE)).toBe(0);
    });
});
