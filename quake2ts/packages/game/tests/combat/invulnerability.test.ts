
import { describe, it, expect, vi, beforeEach } from 'vitest';
import { Entity, DeadFlag } from '../../src/entities/entity.js';
import { EntitySystem } from '../../src/entities/system.js';
import { EntityDamageFlags } from '../../src/combat/damageFlags.js';
import { player_think } from '../../src/entities/player.js';
import { createMockGameExports } from '@quake2ts/test-utils/game/helpers';
import { createPlayerEntityFactory } from '@quake2ts/test-utils/game/factories';
import { createPlayerStateFactory } from '@quake2ts/test-utils';

describe('Invulnerability Powerup', () => {
    let player: Entity;
    let sys: EntitySystem;
    let game: ReturnType<typeof createMockGameExports>;

    beforeEach(() => {
        game = createMockGameExports({
            time: 10,
            entities: {
                 timeSeconds: 10,
                 // Add other EntitySystem methods if player_think needs them
                 scheduleThink: vi.fn(),
                 sound: vi.fn(),
            } as any
        });
        sys = game.entities as unknown as EntitySystem;

        player = createPlayerEntityFactory({
            takedamage: true,
            health: 100,
            deadflag: DeadFlag.Alive,
            flags: 0,
            client: {
                ...createPlayerStateFactory(),
                inventory: {
                    powerups: new Map(),
                    ammo: { counts: [] },
                    ownedWeapons: new Set(),
                    keys: new Set(),
                    items: new Set(),
                } as any,
                weaponStates: {},
                invincible_time: 0,
                buttons: 0,
            } as any
        }) as Entity;
        player.index = 1;
    });

    it('should set GODMODE flag when invincible_time is active', () => {
        // Set invulnerability for 5 seconds
        player.client!.invincible_time = game.time + 5;

        player_think(player, sys);

        expect((player.flags! & EntityDamageFlags.GODMODE)).not.toBe(0);
    });

    it('should clear GODMODE flag when invincible_time expires', () => {
        // Set invulnerability expired
        player.client!.invincible_time = game.time - 1;
        player.flags = EntityDamageFlags.GODMODE; // Assume it was set

        player_think(player, sys);

        expect((player.flags! & EntityDamageFlags.GODMODE)).toBe(0);
    });
});
