# Section 14.1: Weapon Damage & Speed Fixes

**Parent**: Section 14 - Incorrectly Implemented Features
**Category**: Combat System - Weapon Values
**Priority**: P1 - Game Breaking
**Estimated Effort**: 2-3 days
**Can Be Done In Parallel**: Yes

## Overview

All weapon damage values, fire rates, and projectile speeds must match the original Quake II rerelease exactly. Even small differences significantly affect game balance and feel. This subsection covers 8 weapons with incorrect values.

## Prerequisites

- [ ] Understand how to check deathmatch vs single-player mode
- [ ] Know where weapon constants are defined
- [ ] Have original Quake II installed for comparison testing
- [ ] Set up deterministic RNG for testing

---

## 1. Blaster Speed Fix

**Files**:
- `packages/game/src/combat/weapons/firing.ts` lines 300-305
- Possibly: `packages/game/src/combat/weapons/projectiles.ts`

**Original Source**: `../rerelease/p_weapon.cpp` line 1340
**Estimated Time**: 30 minutes

### Current vs Correct

| Property | Current | Correct | Source |
|----------|---------|---------|--------|
| Speed | 1000 | **1500** | p_weapon.cpp:1340 |

### Reason for Change
Original comment: "let the regular blaster projectiles travel a bit faster because it is a completely useless gun"

### Implementation Tasks

- [ ] **Step 1**: Locate constant definition
  ```bash
  grep -n "BLASTER_SPEED\|blaster.*speed\|1000" packages/game/src/combat/weapons/firing.ts
  ```

- [ ] **Step 2**: Change value
  ```typescript
  const BLASTER_SPEED = 1500; // Was 1000, per rerelease/p_weapon.cpp:1340
  ```

- [ ] **Step 3**: Add source comment
  ```typescript
  // Blaster speed 1500 (faster than hyperblaster's 1000)
  // Original comment: "let the regular blaster projectiles travel a bit
  // faster because it is a completely useless gun"
  // @see ../rerelease/p_weapon.cpp:1340
  ```

- [ ] **Step 4**: Check for other references
  ```bash
  grep -r "1000.*blaster\|blaster.*1000" packages/
  ```

- [ ] **Step 5**: Update tests
  ```typescript
  test('blaster speed matches rerelease', () => {
    expect(BLASTER_SPEED).toBe(1500);
  });
  ```

### Testing Checklist

- [ ] **Unit Test**: Constant value is 1500
- [ ] **Integration Test**: Fire blaster, measure projectile speed
  - [ ] From 10 units away: ~0.0067 sec travel time
  - [ ] From 50 units away: ~0.033 sec travel time
  - [ ] From 100 units away: ~0.067 sec travel time
- [ ] **Comparison Test**: Side-by-side with original Q2
  - [ ] Video record both versions
  - [ ] Measure frame-by-frame travel time
  - [ ] Verify matches within 5%
- [ ] **Gameplay Test**: Blaster feels responsive
  - [ ] Can hit moving targets at medium range
  - [ ] Doesn't feel sluggish
  - [ ] Projectile visible but not too fast

### Verification

- [ ] Code review approved
- [ ] All tests pass
- [ ] No regressions in other weapons
- [ ] Documentation updated

---

## 2. Railgun Damage & Kick Fix

**Files**: `packages/game/src/combat/weapons/firing.ts` lines 278-287
**Original Source**: `../rerelease/p_weapon.cpp` lines 1788-1797
**Estimated Time**: 1 hour

### Current vs Correct

| Property | Mode | Current | Correct | Source |
|----------|------|---------|---------|--------|
| Damage | DM | 150 | **100** | p_weapon.cpp:1788-1791 |
| Damage | SP | 150 | **125** | p_weapon.cpp:1793-1797 |
| Kick | DM | 1 | **200** | p_weapon.cpp:1788-1791 |
| Kick | SP | 1 | **225** | p_weapon.cpp:1793-1797 |

### Impact
- Railgun is 50% overpowered in deathmatch
- Missing kick makes weapon feel wrong
- Affects weapon balance significantly

### Implementation Tasks

- [ ] **Step 1**: Add mode detection
  ```typescript
  function isDeathmatch(): boolean {
    return game.cvar('deathmatch')?.value > 0;
  }
  ```

- [ ] **Step 2**: Fix damage calculation
  ```typescript
  const damage = isDeathmatch() ? 100 : 125;
  // Per rerelease/p_weapon.cpp:1788-1797
  ```

- [ ] **Step 3**: Fix kick calculation
  ```typescript
  const kick = isDeathmatch() ? 200 : 225;
  // Kick affects view punch and player velocity
  ```

- [ ] **Step 4**: Apply both to weapon fire
  ```typescript
  function fireRailgun(player: Entity, ...args) {
    const damage = isDeathmatch() ? 100 : 125;
    const kick = isDeathmatch() ? 200 : 225;

    // Apply damage
    applyDamage(target, damage, player);

    // Apply kick to target
    applyKick(target, kick, direction);
  }
  ```

### Testing Checklist

- [ ] **Unit Tests**:
  - [ ] In DM mode: damage=100, kick=200
  - [ ] In SP mode: damage=125, kick=225

- [ ] **Integration Tests**:
  - [ ] Shoot grunt (100 HP) in DM: dies in 1 hit (was surviving)
  - [ ] Shoot grunt in SP: dies in 1 hit
  - [ ] Shoot tank (750 HP) in DM: requires 8 hits
  - [ ] Shoot tank in SP: requires 6 hits
  - [ ] Verify kick pushes player back visibly
  - [ ] Verify view punch occurs

- [ ] **Gameplay Tests**:
  - [ ] Railgun feels powerful but not overpowered
  - [ ] Recoil/kick provides feedback
  - [ ] Balance feels like original

### Verification

- [ ] Tested in both DM and SP modes
- [ ] Damage numbers verified against monster HP
- [ ] Kick effect visible and feels correct
- [ ] No other weapons affected

---

## 3. Chaingun Burst Mechanics Fix

**Files**: `packages/game/src/combat/weapons/firing.ts` lines 260-276
**Original Source**: `../rerelease/p_weapon.cpp` lines 1556-1666
**Estimated Time**: 1 day (complex)

### Current vs Correct

| Aspect | Current | Correct | Impact |
|--------|---------|---------|--------|
| Damage (DM) | 8 | **6** | 33% overpowered |
| Damage (SP) | 8 | **8** | Correct |
| Shots/frame | Always 1 | **1-3 based on spin** | 66% underpowered |
| Spin-up | None | State machine | Missing feature |
| Sound | Per-shot | Looping | Wrong |

### Original Behavior

The chaingun has a **spin-up mechanic**:
1. Frame 1 after trigger: Fire 1 shot
2. Frame 2 while held: Fire 2 shots
3. Frame 3+ while held: Fire 3 shots per frame
4. Release trigger: Reset to frame 1

This means sustained fire = 3x fire rate of current implementation!

### Implementation Tasks

#### Part A: Fix Damage Values (Easy)

- [ ] **Step 1**: Add mode check
  ```typescript
  const damage = isDeathmatch() ? 6 : 8;
  // Per rerelease/p_weapon.cpp:1556-1559
  ```

#### Part B: Add Spin-Up State (Medium)

- [ ] **Step 2**: Add state to player or weapon system
  ```typescript
  interface WeaponState {
    chaingun_shots: number;  // 0-3, increases while firing
    chaingun_spinning: boolean;
  }
  ```

- [ ] **Step 3**: Initialize state
  ```typescript
  player.weaponState = {
    chaingun_shots: 0,
    chaingun_spinning: false
  };
  ```

- [ ] **Step 4**: Update state on fire
  ```typescript
  function fireChaingun(player: Entity) {
    if (!player.weaponState.chaingun_spinning) {
      player.weaponState.chaingun_spinning = true;
      player.weaponState.chaingun_shots = 1;
    } else {
      player.weaponState.chaingun_shots = Math.min(
        player.weaponState.chaingun_shots + 1,
        3
      );
    }

    const shots = player.weaponState.chaingun_shots;
    const damage = isDeathmatch() ? 6 : 8;

    // Fire multiple bullets
    for (let i = 0; i < shots; i++) {
      fireBullet(player, damage, kick, spread);
    }

    // Consume ammo for all shots
    consumeAmmo(player, shots);
  }
  ```

- [ ] **Step 5**: Reset on release
  ```typescript
  function onChaingunReleased(player: Entity) {
    player.weaponState.chaingun_spinning = false;
    player.weaponState.chaingun_shots = 0;
    stopChaingunSound(player);
  }
  ```

#### Part C: Add Looping Sound (Easy)

- [ ] **Step 6**: Start sound loop on first shot
  ```typescript
  if (player.weaponState.chaingun_shots === 1) {
    playLoopingSound(player, "weapons/chngnl1a.wav");
  }
  ```

- [ ] **Step 7**: Stop on release
  ```typescript
  stopLoopingSound(player, "weapons/chngnl1a.wav");
  ```

### Testing Checklist

- [ ] **Unit Tests**:
  - [ ] Damage: 6 in DM, 8 in SP
  - [ ] Shot progression: 1, 2, 3, 3, 3...
  - [ ] Ammo consumption: matches shots fired
  - [ ] Reset on release

- [ ] **Integration Tests**:
  - [ ] Hold fire for 1 second
    - [ ] At 10 Hz tick: ~10 frames
    - [ ] Shots: 1 + 2 + (3*8) = 27 bullets
  - [ ] Quick tap: exactly 1 bullet
  - [ ] Fire-release-fire: resets to 1 bullet
  - [ ] Sound starts frame 1, loops during fire, stops on release

- [ ] **Comparison Tests**:
  - [ ] Video comparison with original Q2
  - [ ] Count bullets per second
  - [ ] Original: ~20-25 bullets/sec sustained
  - [ ] Current implementation: ~10 bullets/sec
  - [ ] After fix: matches original

- [ ] **Gameplay Tests**:
  - [ ] Chaingun feels powerful when spun up
  - [ ] Sound feedback matches fire rate
  - [ ] Visual muzzle flash rate feels correct
  - [ ] Ammo drains appropriately (faster when spun up)

### Verification

- [ ] State machine works correctly
- [ ] Fire rate matches original
- [ ] Sound loop works
- [ ] Ammo consumption correct
- [ ] No bugs with weapon switching during spin-up

---

## 4. Rocket Launcher Random Damage Fix

**Files**: `packages/game/src/combat/weapons/firing.ts` lines 308-318
**Original Source**: `../rerelease/p_weapon.cpp` lines 1284-1291
**Estimated Time**: 1 hour

### Current vs Correct

| Property | Current | Correct | Source |
|----------|---------|---------|--------|
| Direct damage | Fixed 100 | **Random 100-120** | p_weapon.cpp:1284 |
| Radius damage | 100 | **120** | p_weapon.cpp:1285 |
| Both scale with quad | No | **Yes** | p_weapon.cpp:1287-1291 |

### Implementation Tasks

- [ ] **Step 1**: Use deterministic random
  ```typescript
  // WRONG: const damage = 100;
  const directDamage = game.random.irandom(100, 120);
  // irandom(a,b) returns integer in [a,b] inclusive
  ```

- [ ] **Step 2**: Separate radius damage
  ```typescript
  let directDamage = game.random.irandom(100, 120);
  let radiusDamage = 120;
  ```

- [ ] **Step 3**: Apply quad damage multiplier
  ```typescript
  const quadMult = getQuadDamageMultiplier(player); // Returns 4 if quad active
  directDamage *= quadMult;
  radiusDamage *= quadMult;
  ```

- [ ] **Step 4**: Apply both damage types
  ```typescript
  // Direct hit
  if (trace.entity) {
    applyDamage(trace.entity, directDamage, player, MOD_ROCKET);
  }

  // Radius damage to all nearby
  applyRadiusDamage(
    trace.endpos,
    trace.entity,
    player,
    radiusDamage,
    ROCKET_RADIUS,
    MOD_ROCKET_SPLASH
  );
  ```

### Testing Checklist

- [ ] **Unit Tests**:
  - [ ] irandom(100, 120) returns value in range
  - [ ] Multiple calls return different values
  - [ ] With quad: damage is 4x

- [ ] **Integration Tests**:
  - [ ] Direct hit on grunt: 100-120 damage
  - [ ] Splash near grunt: up to 120 damage (distance-scaled)
  - [ ] With quad: direct hit 400-480 damage
  - [ ] Determinism: same seed = same damage sequence

- [ ] **Gameplay Tests**:
  - [ ] Rockets feel somewhat random but consistent
  - [ ] Sometimes 1-shots 100 HP enemies, sometimes not
  - [ ] Splash damage visible and effective

### Verification

- [ ] Uses game.random (deterministic)
- [ ] Separate direct and radius damage
- [ ] Quad damage applies correctly
- [ ] Matches original behavior

---

## 5. HyperBlaster DM Damage Fix

**Files**: `packages/game/src/combat/weapons/firing.ts` lines 289-298
**Original Source**: `../rerelease/p_weapon.cpp` lines 1419-1422
**Estimated Time**: 30 minutes

### Current vs Correct

| Property | Mode | Current | Correct | Source |
|----------|------|---------|---------|--------|
| Damage | DM | 20 | **15** | p_weapon.cpp:1419-1422 |
| Damage | SP | 20 | **20** | p_weapon.cpp:1419-1422 |

### Implementation Tasks

- [ ] **Step 1**: Add mode check
  ```typescript
  const damage = isDeathmatch() ? 15 : 20;
  // Per rerelease/p_weapon.cpp:1419-1422
  ```

- [ ] **Step 2**: Optional - Add barrel rotation
  ```typescript
  // Visual accuracy improvement (optional)
  const rotation = (gunframe - 5) * 2 * Math.PI / 6;
  offset[0] = -4 * Math.sin(rotation);
  offset[1] = 4 * Math.cos(rotation);
  // Per rerelease/p_weapon.cpp:1414-1417
  ```

### Testing Checklist

- [ ] DM mode: 15 damage per shot
- [ ] SP mode: 20 damage per shot
- [ ] Visual: barrel rotates (if implemented)

---

## 6. Super Shotgun Spread Pattern Fix

**Files**: `packages/game/src/combat/weapons/firing.ts` lines 205-247
**Original Source**: `../rerelease/p_weapon.cpp` lines 1745-1752
**Estimated Time**: 1 hour

### Current vs Correct

| Aspect | Current | Correct |
|--------|---------|---------|
| Pattern | 20 pellets, simple spread | Two 10-pellet volleys |
| Barrel 1 | - | YAW - 5 degrees |
| Barrel 2 | - | YAW + 5 degrees |

### Implementation Tasks

- [ ] **Step 1**: Split into two volleys
  ```typescript
  // First barrel (left, 10 pellets, angled left)
  fireMultiplePellets(player, 10, yaw - 5, pitch, spread);

  // Second barrel (right, 10 pellets, angled right)
  fireMultiplePellets(player, yaw + 5, pitch, spread);
  ```

- [ ] **Step 2**: Verify spread matches
  ```typescript
  const DEFAULT_SSHOTGUN_HSPREAD = 1000;
  const DEFAULT_SSHOTGUN_VSPREAD = 500;
  ```

### Testing Checklist

- [ ] Shoots 20 pellets total (10+10)
- [ ] Pattern spreads horizontally (left/right barrels)
- [ ] Visual pattern looks like original
- [ ] Damage at point-blank: 20 pellets * damage = total

---

## 7. BFG Damage Fix

**Files**: `packages/game/src/combat/weapons/projectiles.ts` lines 152-225
**Original Source**: `../rerelease/p_weapon.cpp` lines 1845-1848
**Estimated Time**: 15 minutes (just damage, see 14.2 for laser fix)

### Current vs Correct

| Property | Mode | Current | Correct |
|----------|------|---------|---------|
| Damage | DM | 200 | **200** ✓ |
| Damage | SP | 200 | **500** ✗ |

### Implementation Tasks

- [ ] **Step 1**: Fix damage
  ```typescript
  const damage = isDeathmatch() ? 200 : 500;
  // Per rerelease/p_weapon.cpp:1845-1848
  ```

**Note**: BFG in-flight lasers are a separate, larger issue covered in subsection 14.2

### Testing Checklist

- [ ] DM: 200 damage
- [ ] SP: 500 damage
- [ ] Direct hit kills most enemies in SP

---

## 8. Tank Machinegun Damage Fix

**Files**: `packages/game/src/entities/monsters/tank.ts` (find TankMachineGun function)
**Original Source**: `../rerelease/g_weapon.cpp` or `m_tank.cpp`
**Estimated Time**: 15 minutes

### Current vs Correct

| Property | Current | Correct |
|----------|---------|---------|
| Damage | 10 | **20** |

### Implementation Tasks

- [ ] **Step 1**: Find tank machinegun damage
  ```bash
  grep -n "damage.*10\|TankMachineGun" packages/game/src/entities/monsters/tank.ts
  ```

- [ ] **Step 2**: Change to 20
  ```typescript
  const damage = 20; // Was 10, per rerelease/m_tank.cpp or g_weapon.cpp
  ```

### Testing Checklist

- [ ] Tank machinegun does 20 damage per hit
- [ ] Tank is appropriately threatening
- [ ] Matches original tank difficulty

---

## Summary Checklist

### All Fixes Applied
- [ ] Blaster speed: 1000 → 1500
- [ ] Railgun DM: 150/1 → 100/200
- [ ] Railgun SP: 150/1 → 125/225
- [ ] Chaingun DM: 8 → 6
- [ ] Chaingun burst: 1 → 1-3 shots
- [ ] Chaingun sound: loop added
- [ ] Rocket: fixed → random 100-120 + separate radius
- [ ] HyperBlaster DM: 20 → 15
- [ ] Super Shotgun: simple → dual-barrel pattern
- [ ] BFG SP: 200 → 500
- [ ] Tank gun: 10 → 20

### All Tests Pass
- [ ] Unit tests
- [ ] Integration tests
- [ ] Comparison tests
- [ ] Gameplay tests

### Documentation Updated
- [ ] All source references added
- [ ] All changes documented
- [ ] No TODOs remain

### Ready for Review
- [ ] Code review requested
- [ ] QA testing requested
- [ ] Ready to merge
