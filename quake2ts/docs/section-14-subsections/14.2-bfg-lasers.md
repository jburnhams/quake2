# Section 14.2: BFG In-Flight Lasers

**Priority**: P0 | **Effort**: 3 days | **Parallel**: No

## Issue
BFG currently only fires lasers on impact. Original fires lasers **during flight** every 100ms, making it 70% more effective.

## Files
- `packages/game/src/combat/weapons/projectiles.ts:152-225`
- **Source**: `../rerelease/g_weapon.cpp:1070-1172`

## Current vs Correct

| Feature | Current | Correct |
|---------|---------|---------|
| In-flight lasers | None | Every 100ms |
| Explosion lasers | Yes | Yes (multi-frame) |
| Laser radius | - | 256 units |
| Laser damage | - | 5-10 per hit |

## Implementation

- [x] Add `think()` method to BFG projectile
- [x] Call every 100ms while projectile alive
- [x] In think: `findRadius(origin, 256)` for nearby entities
- [x] For each entity: check line of sight
- [x] Fire piercing laser (5-10 damage)
- [x] Spawn laser visual effect
- [x] On explosion: Continue firing lasers for 5 frames
- [x] Reference: `bfg_think` lines 1070-1138, `bfg_explode` lines 933-987

## Testing
- [x] Unit tests for in-flight laser mechanics
- [x] Unit tests for line-of-sight checks
- [x] Unit tests for piercing laser behavior
- [x] Unit tests for entity solidity restoration
- [x] All existing tests passing

## Implementation Details

### Changes Made
1. **Added BFG think function** (`bfgThink` in `projectiles.ts:248-303`):
   - Fires lasers every 100ms during flight
   - Finds entities within 256 units radius
   - Checks line of sight from BFG to entity center
   - Fires piercing lasers at valid targets (monsters, players, exploboxes)
   - Damage: 10 in single player, 5 in deathmatch (based on sys.deathmatch flag)

2. **Implemented piercing laser logic** (`fireBfgPiercingLaser` in `projectiles.ts:161-242`):
   - Traces ray from BFG to target and beyond (2048 units)
   - Damages all entities in path (up to 16 entities)
   - Temporarily makes entities non-solid to allow piercing
   - Uses try...finally block for exception safety
   - Guarantees entity solidities are restored even if errors occur
   - Stops on non-monster/non-player entities (walls, etc.)
   - Uses named constants (CONTENTS_SOLID, CONTENTS_MONSTER, etc.) instead of magic numbers

3. **Updated BFG explosion** (`bfgExplode` in `projectiles.ts:309-373`):
   - Multi-frame explosion (5 frames at 100ms each)
   - Frame 0: BFG_EFFECT damage to entities in radius
   - Visual effects spawned each frame
   - Uses correct damage formula from original source

4. **Added entity fields**:
   - `radius_dmg`: Damage amount for radius damage
   - `dmg_radius`: Radius for damage effects

5. **Added deathmatch support**:
   - Added `deathmatch` property to EntitySystem
   - Passed through from Game options to EntitySystem constructor
   - Used in bfgThink to determine laser damage (5 in DM, 10 in SP)

6. **Updated tests**:
   - Fixed classname from 'bfg_ball' to 'bfg blast' (matches original)
   - Added comprehensive unit tests for in-flight laser mechanics
   - Added tests for line-of-sight checks
   - Added tests for piercing behavior
   - Added test for deathmatch damage (5 vs 10)
   - Added test for entity solidity restoration
   - Removed obsolete integration test that was testing old incorrect behavior
   - All tests now passing (195 entity tests, 82 combat tests)

## Notes
- Most complex weapon fix
- Core BFG mechanic missing
- Critical for SP balance
