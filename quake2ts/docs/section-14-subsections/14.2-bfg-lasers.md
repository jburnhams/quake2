# 14.2 BFG Lasers

## Status: Blocked

### Summary of Work

*   **In-Flight Laser Attack:** Implemented the BFG projectile's in-flight laser attack in the `bfgBall.think` function in `packages/game/src/entities/projectiles.ts`. This function now finds nearby damageable entities within a 256-unit radius, performs a line-of-sight check, and deals 10 points of `BFG_LASER` damage every 100ms.
*   **Multi-Frame Explosion:** Implemented the multi-frame BFG explosion in the `bfgExplode` function. When the BFG ball detonates (via its `touch` function), it now schedules `bfgExplode` to run for 5 frames (every 100ms), dealing damage and creating laser effects on each frame.
*   **New In-Flight Laser Test:** Created a new, dedicated test file, `packages/game/tests/entities/bfg_flight.test.ts`, to specifically validate the in-flight laser behavior. This test spawns a BFG projectile and several monsters and asserts that the monsters are damaged correctly over multiple game frames.
*   **Existing Test Updates:** Updated the existing BFG test file, `packages/game/tests/combat/bfg.test.ts`, to account for the new asynchronous, multi-frame explosion. The tests now correctly advance the game time to allow the explosion to complete before asserting the final damage.

### Blocker

The new in-flight laser test in `bfg_flight.test.ts` is currently failing. The test asserts that `T_Damage` is called on the first and second frames of the projectile's flight, but the mock is only called on the first frame.

The root cause appears to be an issue within the test environment where the projectile's `think` function is not being called on the second frame. The implementation correctly reschedules the `think` function using `sys.scheduleThink`, but the `EntitySystem` does not seem to be executing it on the subsequent frame within the test's scope.

Multiple attempts to debug and fix the test have been unsuccessful. The implementation is believed to be correct, but the test cannot currently verify it.
