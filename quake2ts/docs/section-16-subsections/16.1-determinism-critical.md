# Section 16.1: Determinism Violations (CRITICAL)

**Parent**: Section 16 - Code Quality & Determinism Fixes
**Category**: Critical Bug - Breaks Save/Load
**Priority**: P0 - **MUST FIX IMMEDIATELY**
**Estimated Effort**: 2-3 days
**Can Be Done In Parallel**: Yes (one person per file)

## Overview

**CRITICAL**: The game currently uses `Math.random()` in 18+ files, making the game completely non-deterministic. This breaks:
- Save/load system (loading a save produces different outcomes)
- Replay system (same inputs produce different results)
- Testing (can't write reproducible tests)
- Future multiplayer (clients will desync)

**This is the #1 priority fix across the entire codebase.**

## Why This Matters

Quake II uses a deterministic random number generator so that:
1. **Saves work**: Loading a save at frame 1000 continues identically to not saving
2. **Demos work**: Recording inputs can reproduce exact gameplay
3. **Netcode works**: Server and client can stay in sync with same RNG seed
4. **Tests work**: Automated tests produce consistent results

Using `Math.random()` breaks all of this because it's non-seeded and non-reproducible.

## Affected Files (18 total)

### Monster AI Files (15 files)
- [ ] `packages/game/src/entities/monsters/flyer.ts:96`
- [ ] `packages/game/src/entities/monsters/attack.ts:11`
- [ ] `packages/game/src/entities/monsters/parasite.ts:42`
- [ ] `packages/game/src/entities/monsters/jorg.ts:90,108,161,166,178`
- [ ] `packages/game/src/entities/monsters/mutant.ts:41`
- [ ] `packages/game/src/entities/monsters/chick.ts:42`
- [ ] `packages/game/src/entities/monsters/soldier.ts:307,333`
- [ ] `packages/game/src/entities/monsters/flipper.ts:31`
- [ ] `packages/game/src/entities/monsters/makron.ts:90,197,208`
- [ ] `packages/game/src/entities/monsters/boss2.ts:91,103,147`
- [ ] `packages/game/src/entities/monsters/brain.ts:33`
- [ ] `packages/game/src/entities/monsters/tank.ts:91,97,297`
- [ ] `packages/game/src/entities/monsters/gunner.ts:75,119,239`
- [ ] `packages/game/src/entities/monsters/supertank.ts:131,195,209`
- [ ] `packages/game/src/entities/monsters/medic.ts:151`

### Utility Files (2 files)
- [ ] `packages/game/src/entities/utils.ts:57-59`
- [ ] `packages/engine/src/render/particleSystem.ts:65`

### Placeholder Random Helpers (Found in multiple files)
```typescript
// These indicate awareness but non-compliance:
// packages/game/src/entities/monsters/parasite.ts:41-42
// Helper to access deterministic RNG or Math.random
const random = () => Math.random();  // ← WRONG!
```

## Fix Pattern

### Wrong (Current)
```typescript
// NON-DETERMINISTIC - will break save/load!
const damage = 5 + Math.random() * 5;          // Returns 5-10
if (Math.random() < 0.5) attack();             // 50% chance
const x = (Math.random() - 0.5) * 2;           // -1 to 1
const choice = Math.floor(Math.random() * 3);  // 0, 1, or 2
```

### Correct (After Fix)
```typescript
// DETERMINISTIC - same seed produces same results
const damage = 5 + game.random.frandom() * 5;     // Returns 5-10
if (game.random.frandom() < 0.5) attack();        // 50% chance
const x = game.random.crandom();                  // -1 to 1
const choice = game.random.irandom(0, 2);         // 0, 1, or 2
```

## Implementation Guide

### Step 1: Understand the RNG API

The game has a deterministic RNG in `packages/shared/src/math/random.ts`:

```typescript
interface RandomGenerator {
  // Returns float in [0, 1)
  frandom(): number;

  // Returns float in [-1, 1)
  crandom(): number;

  // Returns integer in [min, max] inclusive
  irandom(min: number, max: number): number;

  // Get/set seed for reproducibility
  getSeed(): number;
  setSeed(seed: number): void;
}
```

Access via: `game.random.frandom()` etc.

### Step 2: Fix Each File

For each file in the list above:

- [ ] **2.1**: Read the file and locate all `Math.random()` calls
  ```bash
  grep -n "Math.random" packages/game/src/entities/monsters/flyer.ts
  ```

- [ ] **2.2**: For each call, determine correct replacement:
  | Math.random() usage | Replace with |
  |---------------------|--------------|
  | `Math.random()` | `game.random.frandom()` |
  | `Math.random() - 0.5` | `game.random.crandom() / 2` |
  | `(Math.random() - 0.5) * 2` | `game.random.crandom()` |
  | `Math.floor(Math.random() * N)` | `game.random.irandom(0, N-1)` |
  | `Math.random() * (max - min) + min` | `min + game.random.frandom() * (max - min)` |

- [ ] **2.3**: Ensure function has access to `game` parameter
  ```typescript
  // BEFORE:
  function monsterAttack(self: Entity) {
    if (Math.random() < 0.5) { // ...

  // AFTER:
  function monsterAttack(self: Entity, game: GameState) {
    if (game.random.frandom() < 0.5) { // ...
  ```

- [ ] **2.4**: Update all callers to pass `game`
  ```typescript
  // Update caller sites
  monsterAttack(self, game);
  ```

- [ ] **2.5**: Remove any placeholder `random()` helper functions
  ```typescript
  // DELETE THIS:
  // Helper to access deterministic RNG or Math.random
  const random = () => Math.random();

  // USE THIS INSTEAD:
  game.random.frandom()
  ```

### Step 3: Special Case - Particle System

File: `packages/engine/src/render/particleSystem.ts:65`

Current:
```typescript
constructor(maxParticles: number, random: () => number = Math.random) {
  this.random = random;
}
```

Fix:
```typescript
constructor(maxParticles: number, random: RandomGenerator) {
  this.random = random;
}

// Update all callers:
const particles = new ParticleSystem(1000, game.random);
```

### Step 4: Verification

After fixing all files:

- [ ] **4.1**: Search for remaining violations
  ```bash
  grep -r "Math\.random" packages/game/src packages/shared/src
  # Should return ZERO results
  ```

- [ ] **4.2**: Run determinism test
  ```typescript
  test('game is deterministic', () => {
    const seed = 12345;
    const run1 = runGameWithSeed(seed, 1000);
    const run2 = runGameWithSeed(seed, 1000);
    expect(run1.finalState).toEqual(run2.finalState);
  });
  ```

- [ ] **4.3**: Test save/load
  ```typescript
  test('save/load produces same outcome', () => {
    const game = createGame(12345);
    runFrames(game, 500);
    const saveData = saveGame(game);

    // Path 1: Continue without loading
    const continue1 = game.clone();
    runFrames(continue1, 500);

    // Path 2: Load and continue
    const loaded = loadGame(saveData);
    runFrames(loaded, 500);

    expect(hashGameState(continue1)).toBe(hashGameState(loaded));
  });
  ```

## Detailed File Fixes

### File 1: flyer.ts

**Location**: `packages/game/src/entities/monsters/flyer.ts:96`

**Current Code**:
```typescript
const damage = 5 + Math.random() * 5;
```

**Fix Tasks**:
- [ ] Change to: `const damage = 5 + game.random.frandom() * 5;`
- [ ] Ensure `flyerAttack` function has `game: GameState` parameter
- [ ] Update all callers of `flyerAttack` to pass `game`
- [ ] Add comment: `// Damage 5-10, per rerelease/m_flyer.cpp:XXX`

---

### File 2: attack.ts (Helper Function)

**Location**: `packages/game/src/entities/monsters/attack.ts:11`

**Current Code**:
```typescript
// Helper function used by multiple monsters
function randomDirection() {
  return 2 * Math.random() - 1;  // Returns -1 to 1
}
```

**Fix Tasks**:
- [ ] Change signature: `function randomDirection(game: GameState): number`
- [ ] Change to: `return game.random.crandom();`
- [ ] Update ALL callers (in multiple monster files)
- [ ] Or better: just use `game.random.crandom()` inline and delete this function

---

### File 3: utils.ts (Vector Random)

**Location**: `packages/game/src/entities/utils.ts:57-59`

**Current Code**:
```typescript
export function randomVector3(): Vec3 {
  const x = (Math.random() - 0.5) * 2;  // -1 to 1
  const y = (Math.random() - 0.5) * 2;
  const z = (Math.random() - 0.5) * 2;
  return { x, y, z };
}
```

**Fix Tasks**:
- [ ] Change signature: `export function randomVector3(random: RandomGenerator): Vec3`
- [ ] Change to:
  ```typescript
  return {
    x: random.crandom(),
    y: random.crandom(),
    z: random.crandom()
  };
  ```
- [ ] Update all callers to pass `game.random`
- [ ] Add JSDoc explaining this is for deterministic randomness

---

### Files 4-18: Monster AI Files

For each remaining monster file, follow this process:

- [ ] **Step A**: Find all Math.random() calls
  ```bash
  grep -n "Math.random" <file>
  ```

- [ ] **Step B**: For each occurrence:
  - [ ] Identify the function containing it
  - [ ] Add `game: GameState` parameter if not present
  - [ ] Replace `Math.random()` with appropriate `game.random.*()` call
  - [ ] Update all callers

- [ ] **Step C**: Remove any `const random = () => Math.random()` helpers

- [ ] **Step D**: Test the monster:
  - [ ] Spawn monster in test
  - [ ] Run with seed 1, record behavior
  - [ ] Run with seed 1 again, verify identical behavior

## Testing Strategy

### Unit Tests

Create `packages/game/tests/determinism.test.ts`:

```typescript
describe('Determinism', () => {
  test('monsters are deterministic', () => {
    const monsters = ['flyer', 'gunner', 'tank', /*...*/];

    for (const monsterType of monsters) {
      const seed = 12345;

      // Run 1
      const game1 = createGameWithSeed(seed);
      const monster1 = spawnMonster(game1, monsterType);
      for (let i = 0; i < 100; i++) game1.runFrame();
      const state1 = hashMonsterState(monster1);

      // Run 2
      const game2 = createGameWithSeed(seed);
      const monster2 = spawnMonster(game2, monsterType);
      for (let i = 0; i < 100; i++) game2.runFrame();
      const state2 = hashMonsterState(monster2);

      expect(state1).toBe(state2);
    }
  });

  test('entire game is deterministic', () => {
    const seed = 12345;
    const frames = 10000;

    const run1 = runGameWithSeed(seed, frames);
    const run2 = runGameWithSeed(seed, frames);

    expect(run1.hash).toBe(run2.hash);
  });

  test('Math.random is not used', () => {
    // This test just checks no Math.random in source
    const files = glob('packages/game/src/**/*.ts');
    for (const file of files) {
      const content = readFileSync(file, 'utf8');
      expect(content).not.toContain('Math.random');
    }
  });
});
```

### Integration Tests

- [ ] Load map with monsters
- [ ] Run for 1000 frames with seed 12345
- [ ] Record final game state hash
- [ ] Repeat 10 times
- [ ] All hashes must be identical

### Manual Testing

- [ ] Play game for 5 minutes
- [ ] Save game
- [ ] Load game
- [ ] Continue playing
- [ ] Should feel exactly the same (no sudden behavior changes)

## Common Pitfalls

### Pitfall 1: Missing game parameter

```typescript
// WRONG - function can't access game.random
function attack(self: Entity) {
  if (Math.random() < 0.5) { // ERROR: can't fix without game
```

**Fix**: Add parameter:
```typescript
function attack(self: Entity, game: GameState) {
  if (game.random.frandom() < 0.5) {
```

### Pitfall 2: Forgetting to update callers

```typescript
// Fixed function:
function attack(self: Entity, game: GameState) { /*...*/ }

// But caller not updated:
someMonster.attack(monster);  // ERROR: missing game parameter
```

**Fix**: Update all call sites:
```typescript
someMonster.attack(monster, game);
```

### Pitfall 3: Wrong replacement

```typescript
// WRONG: Math.random() returns [0, 1), not [0, 1]
if (Math.random() <= 0.5)  →  if (game.random.frandom() <= 0.5)  // ✓

// WRONG: off-by-one
Math.floor(Math.random() * 3)  →  game.random.irandom(0, 2)  // ✓ not irandom(0, 3)
```

### Pitfall 4: Hidden Math.random in libraries

```typescript
// If you import a library that uses Math.random():
import { shuffle } from 'some-library';  // might use Math.random!

// Solution: implement your own or find deterministic version
function deterministicShuffle<T>(arr: T[], random: RandomGenerator): T[] {
  // Fisher-Yates with deterministic RNG
}
```

## Progress Tracking

### Monster Files (15)
- [ ] attack.ts
- [ ] boss2.ts
- [ ] brain.ts
- [ ] chick.ts
- [ ] flipper.ts
- [ ] flyer.ts
- [ ] gunner.ts
- [ ] jorg.ts
- [ ] makron.ts
- [ ] medic.ts
- [ ] mutant.ts
- [ ] parasite.ts
- [ ] soldier.ts
- [ ] supertank.ts
- [ ] tank.ts

### Utility Files (2)
- [ ] entities/utils.ts
- [ ] render/particleSystem.ts

### Placeholder Helpers Removed
- [ ] All `const random = () => Math.random()` deleted

### Verification
- [ ] No Math.random in grep search
- [ ] Determinism test passes (10 runs)
- [ ] Save/load test passes
- [ ] All monster AI tests pass

### Documentation
- [ ] All changes commented with source refs
- [ ] Determinism guide created
- [ ] PR description explains changes

## Success Criteria

- [ ] **Zero** uses of `Math.random()` in packages/game and packages/shared
- [ ] 10 consecutive test runs with same seed produce identical results
- [ ] Save/load at frame 1000 continues identically to not saving
- [ ] All monster AI functions accept `game` parameter
- [ ] All tests pass
- [ ] Code review approved
- [ ] Ready to merge

---

**Estimated Total Time**: 2-3 days with 1 person, 1 day with 3 people (parallel)
**Blocker**: None - can start immediately
**Impact**: Fixes save/load system, enables deterministic testing, required for multiplayer
