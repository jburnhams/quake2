# Section 16.4: Type Safety Issues

**Priority**: P2 | **Effort**: 1 week | **Parallel**: Partial

## 1. Loose Entity Typing

**File**: `packages/game/src/entities/entity.ts`

**Problem**: Everything optional, no type discrimination
```typescript
interface Entity {
  enemy?: Entity;        // Should be required for monsters
  movetarget?: Entity;
  health?: number;       // Should be required for damageables
  // ...
}
```

**Solution**: Discriminated unions
- [ ] Create `BaseEntity` (required: origin, angles, classname)
- [ ] Create `DamageableEntity extends BaseEntity` (required: health, takedamage)
- [ ] Create `MonsterEntity extends DamageableEntity` (required: enemy, ideal_yaw)
- [ ] Create `ItemEntity extends BaseEntity`
- [ ] Update type guards
- **Effort**: 3 days

## 2. Magic Numbers

**Problem**: Unnamed constants throughout codebase

**Examples**:
```typescript
findRadius(origin, 256);           // What's 256?
if (Math.random() <= 0.75) {       // Why 0.75?
const friction = 2;                // Why 2?
```

**Solution**: Extract to named constants
- [ ] Search for magic numbers: `grep -E "\b[0-9]{2,}\b" packages/`
- [x] Extract to constants with source refs (Started with `boss2.ts`, `jorg.ts`, `infantry.ts`)
```typescript
const BFG_LASER_RADIUS = 256;      // ../rerelease/g_weapon.cpp:1073
const JORG_ATTACK_CHANCE = 0.75;   // ../rerelease/m_boss31.cpp:245
const WATER_FRICTION = 2.0;        // Tuned to match original
```
- **Effort**: 2 days

## 3. Missing Null Checks

**Problem**: Optional fields accessed without checks
```typescript
self.enemy.health -= damage;  // enemy might be undefined
```

**Solution**: Add null checks or assert non-null
- [ ] Enable `strictNullChecks` in tsconfig
- [ ] Fix all resulting errors
- [ ] Add runtime assertions where appropriate
- **Effort**: 2 days

## 4. Any Types

**Problem**: `any` used to avoid type issues
```bash
grep -rn ": any" packages/game/src | wc -l
```

**Solution**: Replace with proper types
- [x] Find all `: any` (Cleaned up `entity.ts`, `prox.ts`, `projectiles.ts`, `collision.ts`)
- [x] Create `CollisionSurface` interface to replace `any` in `TouchCallback`.
- [ ] Replace with specific types in remaining files
- [ ] Add type guards where needed
- **Effort**: 1-2 days

## 5. Function Signatures

**Problem**: Inconsistent parameter ordering
```typescript
applyDamage(target, damage, attacker);  // inconsistent
applyKick(attacker, kick, target);
```

**Solution**: Standardize parameter order
- [ ] Actor/subject first
- [ ] Target second
- [ ] Modifiers last
- [ ] Refactor for consistency
- **Effort**: 2 days

## Tasks
- [ ] Create entity type hierarchy
- [x] Extract magic numbers to constants (Completed for `boss2.ts`, `jorg.ts`, `infantry.ts`)
- [ ] Enable strictNullChecks and fix
- [x] Replace any types (Collision system surface passing, projectiles, prox mine)
- [ ] Standardize function signatures

## Success Criteria
- [ ] strictNullChecks enabled
- [ ] Zero `any` types in game/shared
- [ ] All magic numbers >10 are named constants
- [ ] Entity types have proper discrimination
- [ ] TypeScript compilation has zero warnings
