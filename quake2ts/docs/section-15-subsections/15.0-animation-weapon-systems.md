# Section 15.0: Foundational Animation & Weapon Systems

**Status**: IN PROGRESS
**Priority**: P0-P1 | **Total Effort**: ~3 weeks | **Parallel**: Sequential (must be done in order)

## Overview

The current implementation has **basic firing mechanics** but is **missing the entire animation and state management framework** that Quake II uses for weapons and player visuals. This affects not just the hand grenade, but all weapons and player presentation.

**Current State**: Weapons fire instantly without animations, state machines, or proper timing
**Target State**: Full Quake II rerelease weapon animation system with proper state management

---

## 15.0.1: P_ProjectSource System

**Source**: `../rerelease/p_weapon.cpp:91-135`
**Priority**: P0 (CRITICAL - currently broken)
**Effort**: 2 days
**Blocks**: Proper weapon positioning, railgun, wall-shot prevention

### Problem

All weapons currently fire from `player.origin`, which causes:
- Shots through walls when player is against a wall
- Railgun penetration doesn't work properly (wrong start position)
- Hand grenade throws from player center, not hand
- No ducking/standing position differences

### Implementation Requirements

- [x] **Eye Position Calculation**
  - Source: `p_weapon.cpp:91-135`
  - Add `viewheight` to player origin
  - Result: Eye-level position for view calculations

- [x] **Weapon Offset Projection**
  - Source: `p_weapon.cpp:107-119`
  - Forward/Right/Up vectors from player angles
  - Apply weapon-specific offsets (e.g., hand grenade: `{2, 0, -14}`)
  - Calculate final projectile origin

- [x] **Angle Limiting**
  - Source: `p_weapon.cpp:1001` (hand grenade specific)
  - Limit upward pitch to -62.5° (prevents throwing behind you)
  - Kill sideways roll angle

- [x] **Wall Trace Prevention**
  - Source: `p_weapon.cpp:126-135`
  - Trace from eye position to calculated shot origin
  - If blocked, use trace endpoint (prevents wall shots)
  - Critical for preventing exploits

### Testing

- [x] Fire weapons while ducking vs standing (different heights)
- [x] Fire weapons against walls (should not shoot through)
- [x] Railgun pierces enemies at correct height
- [x] Hand grenade throws from hand position, not center
- [x] Cannot shoot through walls by standing against them

### Code Locations to Update

- `quake2ts/packages/game/src/combat/weapons/firing.ts` - All fire functions
- Create new `projectSource.ts` for P_ProjectSource implementation
- Update all `createProjectile()` calls to use P_ProjectSource

---

## 15.0.2: Weapon Animation System

**Source**: `../rerelease/p_weapon.cpp:878-1213`
**Priority**: P1 (Core game feel)
**Effort**: 2 weeks
**Blocks**: Hand grenade animations, all weapon animations, proper timing

### Problem

Weapons have **no animation system** at all. The current implementation:
- ✓ Has basic firing logic (damage, ammo consumption)
- ✗ NO weapon state machine
- ✗ NO gun frame animations (ps.gunframe)
- ✗ NO raise/lower/idle/fire sequences
- ✗ NO animation timing system
- ✗ NO weapon switching animations

This means weapons appear to fire instantly with no visual feedback.

### Architecture Overview

Quake II uses a **frame-based animation system** with a **state machine**:

```
WEAPON_ACTIVATING → WEAPON_READY → WEAPON_FIRING → WEAPON_READY
                         ↓
                    WEAPON_DROPPING → (switch weapon)
```

Each state plays specific animation frames at specific times.

### 15.0.2.1: Weapon State Machine

**Source**: `rerelease/g_local.h:629-634`, `p_weapon.cpp:692-950`

- [x] **Add `weaponstate_t` enum**
  ```typescript
  enum WeaponState {
    WEAPON_READY,      // Idle, can fire or switch
    WEAPON_ACTIVATING, // Raising/drawing weapon
    WEAPON_DROPPING,   // Lowering weapon
    WEAPON_FIRING      // Currently firing
  }
  ```

- [x] **Add to player client state**
  - `weaponstate: WeaponState`
  - `weapon_think_time: number` (next animation update time)
  - `weapon_fire_finished: number` (can fire again after this time)
  - `weapon_sound: number` (looping weapon sound index)

- [x] **State Transitions**
  - ACTIVATING: Play raise animation, transition to READY when done
  - READY: Idle animation loop, accept fire/switch inputs
  - FIRING: Play fire animation, call fire logic at fire frame
  - DROPPING: Play lower animation, switch weapon when done

### 15.0.2.2: Gun Frame Animation System

**Source**: `p_weapon.cpp:465, 735-750, 823-871`

- [x] **Add `ps.gunframe` to player state**
  - Current weapon animation frame (0 = no weapon, 1+ = active)
  - Increments each weapon think based on animation timing

- [x] **Frame Definitions Per Weapon**
  - Activation frames: Weapon raising
  - Idle frames: Weapon waiting (with pause frames)
  - Fire frames: Weapon firing sequence
  - Deactivation frames: Weapon lowering

- [x] **Animation Timing**
  - `Weapon_AnimationTime(player)`: Returns frame time (10 Hz = 100ms)
  - Modified by haste powerup, quadfire, etc.
  - `weapon_think_time` controls when to advance to next frame

- [x] **Pause Frames**
  - Idle animation can pause randomly on certain frames
  - Adds natural variation to idle look
  - Example: Hand grenade pauses on frames [29, 34, 39, 48]

### 15.0.2.3: Generic Weapon Functions

**Source**: `p_weapon.cpp:878-978, 1013-1213`

- [x] **Weapon_Generic() - Standard Weapons**
  - Source: Lines 878-950
  - Handles most weapons (shotgun, machinegun, etc.)
  - Parameters: frame ranges, pause frames, fire function
  - Manages full state machine and frame progression

- [ ] **Weapon_Repeating() - Auto Weapons**
  - Source: Lines 952-978
  - For weapons that hold fire button (chaingun, hyperblaster)
  - Special logic for continuous firing
  - Maintains fire state while button held

- [x] **Throw_Generic() - Throwable Weapons**
  - Source: Lines 1013-1213
  - For hand grenade (and future: proximity mines)
  - Hold-to-cook mechanic
  - Special THROW_HOLD frame that loops while button held
  - Primed sound loop while holding
  - Throw on release or explode if held too long

### 15.0.2.4: Hand Grenade Specific (Throw_Generic)

**Source**: `p_weapon.cpp:1013-1213, 1215-1224`

The hand grenade uses `Throw_Generic()` with these specifics:

- [x] **Frame Sequence**
  - Frames 1-4: Prime animation
  - Frame 5 (FRAME_PRIME_SOUND): Play "weapons/hgrena1b.wav" (note: different from current!)
  - Frames 6-10: Continue prime
  - Frame 11 (FRAME_THROW_HOLD): Hold frame - loops while button held
  - Frame 12 (FRAME_THROW_FIRE): Throw frame - actual throw happens here
  - Frames 13-15: Throw follow-through
  - Frame 15 (FRAME_FIRE_LAST): Return to idle
  - Frames 16-48 (FRAME_IDLE_FIRST to FRAME_IDLE_LAST): Idle animation
  - Pause frames: [29, 34, 39, 48]

- [x] **Cooking Logic (in THROW_HOLD frame)**
  - Set `grenade_time = level.time + 3.2s` on first entry to frame 11
  - Play primed loop sound "weapons/hgrenc1b.wav" via `weapon_sound`
  - While button held: Check if `level.time >= grenade_time`
    - If yes: Set `grenade_blew_up = true`, call fire(held=true), wait for `grenade_finished_time`
    - If no: Stay on frame 11, loop
  - On button release: Advance to frame 12, stop loop sound, call fire(held=false)

- [x] **Grenade State Variables** (add to client)
  - `grenade_time: number | null` - When grenade will explode in hand
  - `grenade_finished_time: number | null` - Delay after throw before next action
  - `grenade_blew_up: boolean` - Did it explode in hand?

- [x] **Death Handling**
  - Source: Lines 1019-1024
  - If player dies while holding grenade: Immediately throw it (fire(held=true))

### 15.0.2.5: Weapon Switching

**Source**: `p_weapon.cpp:460-464, 761-809`

- [x] **Weapon Change Request**
  - Player selects new weapon → sets `newweapon`
  - If in READY state: Transition to DROPPING
  - Play weapon lower animation
  - When DROPPING animation completes: Call `ChangeWeapon()`

- [x] **ChangeWeapon() Logic**
  - Remove old weapon from hand
  - Equip new weapon
  - Set state to ACTIVATING
  - Start raise animation

- [ ] **Instant Weapon Switch Option**
  - Source: `instantweap` cvar
  - If enabled: Skip animations, instant switch

- [x] **Auto-Switch on Empty Ammo**
  - Source: `NoAmmoWeaponChange()`
  - When weapon runs out of ammo, auto-switch to best available weapon
  - Can be configured (some players prefer not to auto-switch)

### Testing Requirements

- [x] **Animation Playback**
  - All weapons play raise animation when equipped
  - Weapons idle correctly with pause frames
  - Fire animation plays on trigger, shot fires at fire frame (not before)
  - Lower animation plays when switching

- [x] **Timing**
  - Fire rate matches original (test with stopwatch)
  - Animation speed matches original (10 Hz by default)
  - Haste powerup doubles animation speed

- [x] **Hand Grenade Specific**
  - Prime sound plays at frame 5
  - Hold frame loops smoothly while button held
  - Primed loop sound plays continuously while held
  - Throw animation plays on release
  - Explodes in hand if held 3+ seconds
  - If player dies while holding, grenade is thrown

- [x] **Weapon Switching**
  - Can switch weapons during idle
  - Cannot switch during fire (until fire completes)
  - Animations play correctly during switch
  - Instant switch option bypasses animations

### Code Structure

```
quake2ts/packages/game/src/combat/weapons/
  ├── animation.ts          [NEW] - Weapon_Generic, Weapon_Repeating, Throw_Generic
  ├── frames.ts             [NEW] - Frame definitions for each weapon
  ├── state.ts              [UPDATE] - Add WeaponState enum, animation state
  ├── firing.ts             [UPDATE] - Fire functions now called from animation system
  └── switching.ts          [NEW] - ChangeWeapon, NoAmmoWeaponChange
```

---

## 15.0.3: Player Body Animation System

**Source**: `../rerelease/p_weapon.cpp:1166-1181`, `p_client.cpp`, `m_player.h`
**Priority**: P2 (Visual polish)
**Effort**: 1 week
**Blocks**: Hand grenade throw animation, all player actions looking correct

### Problem

Player body has **no animations**. The player model doesn't react to actions:
- No running animation
- No attack animations
- No pain animations
- No death animations

### Implementation Requirements

- [ ] **Animation Frame Definitions**
  - Source: `rerelease/m_player.h:1-400+`
  - Define all player animation frame constants
  - Running: FRAME_run1 through FRAME_run6
  - Standing attack: FRAME_attack1 through FRAME_attack8 (currently unused in rerelease)
  - Crouching attack: FRAME_crattak1 through FRAME_crattak9
  - Throwing (standing): FRAME_wave08 through FRAME_wave01 (reversed!)
  - Pain: FRAME_pain101 through FRAME_pain104 (and other pain sets)
  - Death: FRAME_death101 through FRAME_death106 (and other death sets)

- [ ] **Animation Priority System**
  - Source: `p_weapon.cpp:1170, 1176`
  - `anim_priority: number` - Higher priority animations override lower
  - `ANIM_BASIC`, `ANIM_ATTACK`, `ANIM_PAIN`, `ANIM_DEATH` priorities
  - `ANIM_REVERSED` flag - Play animation backwards

- [ ] **Animation State (add to client)**
  - `anim_priority: number` - Current animation priority
  - `anim_end: number` - Final frame of current animation
  - `anim_time: number` - Time animation started (for speed calculation)

- [ ] **Hand Grenade Throw Animations**
  - Source: `p_weapon.cpp:1166-1181`
  - **If ducking**: Play FRAME_crattak1 to FRAME_crattak3 (crouching throw)
  - **If standing**: Play FRAME_wave08 to FRAME_wave01 REVERSED (standing throw/wave)
  - Set on fire frame (frame 12 of weapon animation)
  - Only if player alive and using player model

- [ ] **Animation Update System**
  - Advance player.frame each tick based on anim_time and priority
  - When animation completes (reaches anim_end), return to idle
  - Higher priority animations can interrupt lower ones

### Testing

- [ ] Player model animates while moving
- [ ] Hand grenade throw shows proper body animation
- [ ] Crouching vs standing throws use different animations
- [ ] Pain animations play when damaged
- [ ] Death animations play on death

---

## Dependencies & Order

These systems **must be implemented in order**:

1. **P_ProjectSource** (2 days) - Fixes critical weapon positioning bugs
2. **Weapon Animation System** (2 weeks) - Core framework for all weapons
3. **Player Body Animations** (1 week) - Visual polish, depends on weapon system

**Total Sequential Time**: ~3 weeks for one developer

---

## Success Criteria

### P_ProjectSource Complete
- [x] Weapons fire from correct position (hand, not center)
- [x] Cannot shoot through walls by standing against them
- [x] Railgun works correctly
- [x] Ducking changes shot height

### Weapon Animation Complete
- [x] All weapons have raise/lower/fire/idle animations (Infrastructure ready, Hand Grenade implemented)
- [x] Hand grenade can be cooked with proper animations
- [x] Primed loop sound plays while holding grenade
- [x] Weapon switching has animations
- [x] Fire rate timing matches original exactly

### Player Animation Complete
- [ ] Player body shows throw animation when throwing grenade
- [ ] Different animations for ducking vs standing
- [ ] All combat actions have matching body animations

---

## Current Hand Grenade Status Summary

**What's Implemented** (simplified, no animation system):
- ✓ Basic hold-to-cook timer
- ✓ Variable throw speed based on hold time
- ✓ In-hand explosion if held too long
- ✓ Prime sound on start (but wrong sound: "hgrent1a.wav" instead of "hgrena1b.wav")
- ✓ Basic unit tests for mechanics

**What's Missing** (blocked on animation systems):
- ✗ Weapon state machine (ACTIVATING/READY/FIRING/DROPPING)
- ✗ Gun frame animation (ps.gunframe system)
- ✗ Throw_Generic animation sequence (48 frames total)
- ✗ Primed loop sound ("hgrenc1b.wav") while holding
- ✗ Frame-based timing (currently instant, should be frame 5→11→12 sequence)
- ✗ Proper cook timing integrated with THROW_HOLD frame
- ✗ Death handling (throw on death)
- ✗ P_ProjectSource (proper throw origin)
- ✗ Player body throw animation (FRAME_crattak or FRAME_wave)
- ✗ Idle animation with pause frames when weapon is out
- ✗ Raise/lower animations when switching to/from grenade

**Estimate**: Current implementation is ~20% complete. Remaining 80% blocked on 15.0.1, 15.0.2, 15.0.3.

---

## Notes

- The docs claimed hand grenade was "nearly complete" - this is **incorrect**
- The basic throw mechanics work, but without the animation framework
- This is like having a car engine that runs, but no transmission, wheels, or steering
- **All weapons** need this system, not just hand grenade
- This is foundational work that should have been done first
- Without this, the game will feel wrong and unpolished
