# Progress

## Current focus
- Stand up the TypeScript workspace skeleton (pnpm + project references) with placeholder packages and a CI loop that exercises builds/tests.
- Solidify the shared physics helpers (friction, ground/air acceleration, and screen-blend math) so the engine, client, and game can reuse deterministic movement semantics from `rerelease/p_move.cpp` and `q_std.h`.
- Build a deterministic main loop in the engine package that drives a 40 Hz simulation tick with render-time interpolation so the client/game layers can start wiring real frame execution paths.

## Recent additions
- Ported `PM_AirAccelerate` semantics into the shared pmove helpers with Vitest coverage that verifies the 30-unit clamp and wishspeed-driven acceleration (see `rerelease/p_move.cpp` lines 612-636).
- Tightened the shared `G_AddBlend` expectations to mirror `rerelease/q_std.h` line 151 so fully opaque blends accumulate based on the stored alpha fraction before hitting 1.0.
- Added pnpm workspace scaffolding (`packages/{engine,game,client,shared,tools}` and `apps/viewer`) with `tsc -b` wiring for project references.
- Introduced a shared deterministic RNG built on a TypeScript MT19937 port plus `frandom`/`crandom`/`irandom`/`random_time` helpers that mirror `rerelease/g_local.h`, complete with Vitest sequences that match the canonical std::mt19937 outputs for multiple seeds.
- Seeded Vitest with an initial shared math test to validate the harness and strict TypeScript settings.
- Introduced a GitHub Actions workflow that installs dependencies and runs the workspace build/test steps on pushes/PRs touching `quake2ts/**`.
- Implemented `clipVelocityVec3`/`clipVelocityAgainstPlanes` to mirror `PM_ClipVelocity` and the plane resolution loop in `PM_StepSlideMove_Generic`, with unit tests covering crease projection and STOP_EPSILON zeroing.
- Ported `PM_CmdScale` as `pmoveCmdScale` so movement wishvel mixes stay capped at the configured max speed, with Vitest coverage for cardinal, diagonal, and vertical input combinations.
- Added wishdir/wishspeed builders for ground/air and water movement that mirror the setup phases of `PM_AirMove` and `PM_WaterMove`, including the water upward bias and maxspeed halving, with dedicated unit coverage.
- Added an engine-level `FixedTimestepLoop` with accumulator/catch-up limits and interpolation reporting, plus Vitest coverage for accumulator progression, substep capping, and start/stop scheduling.
- Built an `EngineHost` wrapper around the fixed-step loop to drive game simulation snapshots and feed previous/latest frames to the client renderer, with unit coverage for init/shutdown ordering and manual pump control.
- Introduced an `EngineRuntime` harness that wires engine init/shutdown around the host and client/game lifecycles so embedders can spin the fixed-step loop up with a single call; the viewer bootstrap now uses it.
- Added `resolveSlideMove`, a pure clip-plane accumulator mirroring the inner loop of `PM_StepSlideMove_Generic` so slide/crease resolution can be unit-tested outside of the full pmove trace path.
- Added a trace-driven `slideMove` helper that mirrors `PM_SlideMoveGeneric` (minus gravity/stepping) and scripts collision planes through unit tests to verify multi-bump handling.
- Added a pmove-style `stepSlideMove` that mirrors `PM_StepSlideMove`, including the pm_time velocity preservation flag and bounding-box-aware traces, with tests that step onto a 16u ledge and fall back to the flat slide path when stepping is blocked.
- Hardened slide movement to bail when starting in solid geometry and to prevent upward motion from converting into a downward bounce when clipping against ceilings, matching the rerelease guardrails.
- Ported `G_FixStuckObject_Generic` from `rerelease/p_move.cpp` as a pure `fixStuckObjectGeneric` helper that tests each face of the bounding box and keeps the smallest displacement that escapes solid space, complete with Vitest coverage for free, stuck-but-fixable, and no-good-position scenarios.
- Mirrored the rerelease `game.h` collision bitfields (`CONTENTS_*`, `SURF_*`, and the `MASK_*` helpers) in a shared `bsp/contents` module so both the game and client can share the same numeric masks, with exhaustive Vitest coverage keeping every bit position honest.
- Expanded the root build to run the TypeScript project references and every workspace package/app's own `build` script so the entire `quake2ts` tree (engine, game, client, tools, shared, and viewer) is exercised consistently.
- Prepped `@quake2ts/shared` for publication by emitting dual CJS/ESM bundles plus a browser-friendly IIFE build via tsup, while the TypeScript project reference now produces declaration-only output so workspace builds keep `.d.ts` artifacts separate from runtime bundles.
- Rounded out the shared vec3 toolkit with the rerelease `q_vec3.h` bounds and rotation helpers (`ClearBounds`, `AddPointToBounds`, `boxes_intersect`, `R_ConcatRotations`, `RotatePointAroundVector`) so weapon offsets, collision checks, and camera math can reuse the same primitives as the C++ code, complete with Vitest coverage verifying matrix concatenation and arbitrary-axis rotations.
- Introduced a shared water/ground current helper that mirrors the `PM_WaterMove` conveyor math from `rerelease/p_move.cpp` (lines 730-765): the new module exposes the `WaterLevel` enum plus `currentVectorFromContents`, `waterCurrentVelocity`, and `groundCurrentVelocity`, each covered by Vitest cases so the CONTENTS_CURRENT_* flags and the feet-on-ground half-speed rule stay numerically aligned with the C++ original.
- Added a pure `getWaterLevel` helper that mirrors `PM_GetWaterLevel` from `rerelease/p_move.cpp`, probing feet/waist/viewheight samples against a caller-provided `pointcontents` callback so both the game and client can agree on water depth and watertype, with Vitest coverage for dry, shallow, waist-deep, submerged, and crouched cases.
- Mirrored the rerelease `PM_CheckJump` logic in a pure `checkJump` helper alongside freshly ported `pmflags_t`, `pmtype_t`, and `BUTTON_*` bit definitions so both the server and client can manipulate jump gating with identical semantics; Vitest coverage exercises landing timers, button release handling, water restrictions, ground detection, and configurable jump heights.
- Added `computePlayerDimensions` and `checkDuckState`, pure mirrors of `PM_SetDimensions` and `PM_CheckDuck` from `rerelease/p_move.cpp`, so both the authoritative game and client prediction layers can share the same mins/maxs/viewheight triplets and duck-flag transitions. New Vitest coverage exercises crouch entry/exit, dead-player forced ducking, shallow-water gating, and the rerelease-only N64-physics guardrails that skip crouch input entirely.
- Ported `PM_CatagorizePosition` into a pure `categorizePosition` helper that traces the ground, manages `pm_time`/trick/land timers, records the latest surface/contents pair, and reuses the shared water-level probe so every package derives identical ground/water state. Fresh Vitest coverage scripts wedged slopes, high-velocity landings, and the trick-timer/N64 landing cases.
- Added `applyPmoveAddCurrents`, a pure mirror of `PM_AddCurrents` that handles ladder jump/crouch limits, forward/back climb behavior, sidemove projections along ladder planes, and the rerelease water/ground current blending, with Vitest coverage for each control path.
- Added `applyPmoveFlyMove`, mirroring the rerelease spectator/noclip physics so extra fly friction, doubled wishspeed acceleration, and the optional `PM_StepSlideMove` collision path can be reused by both the game and client prediction layers; new Vitest coverage exercises friction decay, button-driven vertical thrust, and the clipped path.
- Added pure `applyPmoveAirMove` and `applyPmoveWaterMove` helpers that mirror the rerelease `PM_AirMove`/`PM_WaterMove` logic, including ladder clamping, conveyor/water current injection, duck-speed limits, gravity handling, and step-slide resolution. New Vitest suites in `packages/shared/tests/move.test.ts` cover ground stepping, airborne acceleration, ladder damping, grapple-specific gravity skips, and underwater drift to keep the shared pmove behavior aligned with the C++ originals.
- Ported the ladder detection + water-jump probing logic (`PM_CheckSpecialMovement`) into a pure `checkSpecialMovement` helper so pmove callers deterministically set the ladder flag and grant water-jump boosts only after the same probe simulation the rerelease performs. A new Vitest suite exercises ladder gating, watertype restrictions, and the successful water-jump path.
- Hardened the shared `applyPmoveAirMove`/`applyPmoveWaterMove` helpers to always seed the canonical Quake II 1.01 overbounce constant before invoking `stepSlideMove`, preventing undefined multipliers from producing NaN velocities during collisions. Fresh regression tests drive both helpers into scripted wall traces to lock down the default.
- Added pure `goodPosition`, `snapPosition`, and `initialSnapPosition` helpers that mirror `PM_GoodPosition`, `PM_SnapPosition`, and `PM_InitialSnapPosition` from `rerelease/p_move.cpp`, wiring them to the shared stuck-object fixer and covering valid, stuck-but-fixable, fallback, and offset-search cases in Vitest.

## Artifacts in this stage
- `docs/rerelease-mapping.md`: structural map of the rerelease server/client/game modules and how they relate to the planned TypeScript/WebGL layers.
- `docs/questions.md`: open questions to resolve before committing to the porting approach.
- `implementation.md`: end-to-end implementation plan and milestones for the quake2ts port.

## Next up
- Expand the engine→game/client interface stubs beyond the placeholder lifecycle/hooks now in the scaffolding packages, now that the fixed-step loop surface exists.
- Sketch the browser asset-ingestion UX (file drop/selector, caching/error UX) aligned with the configstring/index pipeline documented in the plan.
- Enumerate renderer/input abstractions the HUD/client module needs from the engine (pic/font helpers, text metrics, cvars) to keep the UI sandboxed.
- Continue building out the shared pmove helpers (air/water move, clipping/slide helpers, etc.) so client prediction and the authoritative game layer can share identical movement math, now including the clip-plane resolution helper mirrored from `PM_StepSlideMove_Generic` and the stepped variant of `PM_StepSlideMove`.
